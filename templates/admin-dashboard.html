
<h1 class="heading">Dashboard</h1>

<section class="row-1">

    <div class="tile tile-1">
        <div>
            <svg fill="#00ffff" viewBox="0 0 1920 1920" xmlns="http://www.w3.org/2000/svg" stroke="#00ffff">
                <g id="SVGRepo_bgCarrier" stroke-width="0"></g>
                <g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g>
                <g id="SVGRepo_iconCarrier">
                    <path fill-rule="evenodd" clip-rule="evenodd"
                        d="M1451.06 557.963C1456.76 557.07 1462.44 556.179 1468.24 556.179C1717.38 556.179 1920 761.2 1920 1013.31C1920 1265.41 1717.38 1470.43 1468.24 1470.43H1355.29V1356.15H1468.24C1655.04 1356.15 1807.06 1202.33 1807.06 1013.31C1807.06 824.283 1655.04 670.46 1468.24 670.46C1467.28 670.46 1466.34 670.632 1465.41 670.803C1464.48 670.975 1463.55 671.146 1462.59 671.146C1463.2 676.832 1463.97 682.485 1464.73 688.143C1466.48 701.135 1468.24 714.146 1468.24 727.601C1468.24 772.4 1462.48 816.855 1451.29 859.825L1342.08 830.569C1350.78 797.084 1355.29 762.571 1355.29 727.601C1355.29 507.038 1177.98 327.616 960 327.616C747.558 327.616 574.871 498.581 566.287 711.373C604.574 730.115 640.602 753.772 671.887 784.628L592.941 866.339C539.746 813.77 469.609 784.742 395.294 784.742C239.661 784.742 112.941 912.852 112.941 1070.45C112.941 1228.04 239.661 1356.15 395.294 1356.15H564.706V1470.43H395.294C177.318 1470.43 0 1291.01 0 1070.45C0 849.883 177.318 670.46 395.294 670.46C416.188 670.46 436.631 673.203 456.847 676.517C482.598 417.098 697.073 213.334 960 213.334C1181.82 213.334 1368.85 358.7 1438.08 559.607C1442.45 559.312 1446.76 558.637 1451.06 557.963ZM717.572 1282.27L637.722 1201.47L960.056 875.31L1282.28 1201.47L1202.43 1282.27L1016.53 1094.16V1813.33H903.586V1094.16L717.572 1282.27Z">
                    </path>
                </g>
            </svg>
        </div>
        <div>
            <h1 class="number">{{highlights.total_jobs}}</h1>
            <p>Total Jobs Posted </p>
        </div>
    </div>
    <div class="tile tile-2">
        <div>
            <svg fill="#28d5a7 " height="200px" width="200px" version="1.1" id="Capa_1"
                xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
                viewBox="0 0 324.146 324.146" xml:space="preserve">
                <g id="SVGRepo_bgCarrier" stroke-width="0"></g>
                <g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g>
                <g id="SVGRepo_iconCarrier">
                    <path
                        d="M230.645,324.146H25.365c-4.418,0-8-3.582-8-8V69.811c0-4.418,3.582-8,8-8h205.279c4.418,0,8,3.582,8,8v15.766h20.236 c4.418,0,8,3.582,8,8s-3.582,8-8,8h-20.236v20.614h10.01c4.418,0,8,3.582,8,8s-3.582,8-8,8h-10.01v20.615h20.236 c4.418,0,8,3.582,8,8s-3.582,8-8,8h-20.236v20.613h10.01c4.418,0,8,3.582,8,8s-3.582,8-8,8h-10.01v104.727 C238.645,320.564,235.063,324.146,230.645,324.146z M33.365,308.146h189.279V77.811H33.365V308.146z M166.297,293.237 c-20.576,0-37.316-16.739-37.316-37.314s16.74-37.314,37.316-37.314c20.574,0,37.313,16.739,37.313,37.314 S186.871,293.237,166.297,293.237z M166.297,234.609c-11.754,0-21.316,9.562-21.316,21.314s9.562,21.314,21.316,21.314 c11.752,0,21.313-9.562,21.313-21.314S178.049,234.609,166.297,234.609z M298.781,262.335h-36.605c-4.418,0-8-3.582-8-8s3.582-8,8-8 h28.605V16H101.502v25.307c0,4.418-3.582,8-8,8s-8-3.582-8-8V8c0-4.418,3.582-8,8-8h205.278c4.418,0,8,3.582,8,8v246.335 C306.781,258.753,303.198,262.335,298.781,262.335z M105.182,235.255H66.215c-4.418,0-8-3.582-8-8s3.582-8,8-8h38.967 c4.418,0,8,3.582,8,8S109.6,235.255,105.182,235.255z M189.795,199.842H66.215c-4.418,0-8-3.582-8-8s3.582-8,8-8h123.58 c4.418,0,8,3.582,8,8S194.213,199.842,189.795,199.842z M189.795,164.429H66.215c-4.418,0-8-3.582-8-8s3.582-8,8-8h123.58 c4.418,0,8,3.582,8,8S194.213,164.429,189.795,164.429z M105.182,129.016H66.215c-4.418,0-8-3.582-8-8s3.582-8,8-8h38.967 c4.418,0,8,3.582,8,8S109.6,129.016,105.182,129.016z">
                    </path>
                </g>
            </svg>
        </div>
        <div>
            <h1 class="number">{{highlights.total_applications}}</h1>
            <p>Total Applications </p>
        </div>
    </div>
    <div class="tile tile-3">
        <div>
            <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="#000000">
                <g id="SVGRepo_bgCarrier" stroke-width="0"></g>
                <g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g>
                <g id="SVGRepo_iconCarrier">
                    <path
                        d="M19 15C21.2091 15 23 16.7909 23 19V21H21M16 10.874C17.7252 10.4299 19 8.86383 19 6.99999C19 5.13615 17.7252 3.57005 16 3.12601M13 7C13 9.20914 11.2091 11 9 11C6.79086 11 5 9.20914 5 7C5 4.79086 6.79086 3 9 3C11.2091 3 13 4.79086 13 7ZM5 15H13C15.2091 15 17 16.7909 17 19V21H1V19C1 16.7909 2.79086 15 5 15Z"
                        stroke="#f9b851 " stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path>
                </g>
            </svg>
        </div>
        <div>
            <h1 class="number">{{highlights.total_users}}</h1>
            <p>Users Registered</p>
        </div>
    </div>
    <div class="tile tile-4">
        <div>
            <svg version="1.1" id="_x32_" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
                viewBox="0 0 512 512" xml:space="preserve" fill="#000000">
                <g id="SVGRepo_bgCarrier" stroke-width="0"></g>
                <g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g>
                <g id="SVGRepo_iconCarrier">
                    <style type="text/css">
                        .st0 {
                            fill: #FD4D50;
                        }
                    </style>
                    <g>
                        <path class="st0"
                            d="M116.432,392.022h171.717c2.471-7.202,5.6-14.106,9.454-20.584h-181.17V392.022z"></path>
                        <rect x="116.418" y="288.04" class="st0" width="215.202" height="20.563"></rect>
                        <rect x="116.418" y="204.655" class="st0" width="215.202" height="20.569"></rect>
                        <rect x="230.187" y="121.277" class="st0" width="101.433" height="20.562"></rect>
                        <path class="st0"
                            d="M77.375,457.772c-10.619,0-19.202-8.58-19.202-19.199V165.832h117.388c12.945,0,23.492-10.548,23.492-23.566 V24.661h171.646c10.544,0,19.198,8.579,19.198,19.198v271.945c1.673-0.149,3.274-0.149,4.947-0.149 c6.765,0,13.31,0.583,19.71,1.748V43.859c0-24.22-19.71-43.859-43.855-43.859H192.725c-12.799,0-25.094,5.022-34.111,14.114 L47.625,125.098c-9.092,9.021-14.11,21.316-14.11,34.115v279.36c0,24.22,19.639,43.852,43.859,43.852h218.555 c-4.219-7.707-7.564-15.995-9.891-24.653H77.375z M177.159,30.478v98.619c0,10.626-4.144,14.767-14.837,14.767h-98.62 L177.159,30.478z">
                        </path>
                        <path class="st0"
                            d="M394.844,344.719c-46.192,0-83.641,37.446-83.641,83.641c0,46.196,37.448,83.64,83.641,83.64 c46.192,0,83.64-37.445,83.64-83.64C478.485,382.164,441.036,344.719,394.844,344.719z M448.881,401.072l-44.655,54.15 c-2.826,3.565-7.003,5.802-11.534,6.186c-4.535,0.383-9.027-1.122-12.411-4.17l-27.132-24.383 c-2.042-1.833-3.267-4.396-3.406-7.138c-0.142-2.734,0.817-5.419,2.657-7.45l3.65-4.027c1.847-2.032,4.425-3.246,7.17-3.374 c2.745-0.121,5.426,0.852,7.447,2.714l22.661,20.846l45.979-42.473c2.586-2.266,6.464-2.195,8.95,0.191 C450.745,394.508,451.012,398.394,448.881,401.072z">
                        </path>
                    </g>
                </g>
            </svg>
        </div>
        <div>
            <h1 class="number">{{highlights.total_hired}}</h1>
            <p>Candidates Hired </p>
        </div>
    </div>
</section>
<section class="row-2">
    <div class="barContainer">
        <h2>Job Types Distribution</h2>
        <canvas id="barChart"></canvas>
    </div>
    <div class="jobSummaryTable">
        <h2>Recent Postings</h2>
        <table class="summaryTable">
            <thead>
                <tr>
                    <th>Position</th>
                    <th>Company</th>
                    <th>Type</th>
                </tr>
            </thead>
            <tbody>
                {%for job in jobs%}
                <tr>
                    <td>{{job.title}}</td>
                    <td>{{job.company}}</td>
                    <td>{{job.employment_type}}</td>
                </tr>
                {%endfor%}
            </tbody>
            <tfoot>
                <tr>
                    <td colspan="3"><a class="jobs-table-link" hx-get="/manage_jobs" hx-target="#admin-main" hx-trigger="click" hx-indicator=".section-loader-wrapper">View All > </a></td>
                </tr>
            </tfoot>
        </table>

    </div>
</section>
<section class="row-3">
    <div class="doughnutContainer">
        <h2>Applications Distribution</h2>
        <canvas id="doughnutChart"></canvas>
    </div>
    <div class="applicationSummaryTable">
        <h2>Recent Applications</h2>
        <table class="summaryTable">
            <thead>
                <tr>
                    <th>Position</th>
                    <th>Company</th>
                    <th>Applicant Name</th>
                    <th>Applied On</th>
                    <th>Resume</th>
                </tr>
            </thead>
            <tbody>

                {%for application in applications%}
                <tr>
                    <td>{{application.job_title}}</td>
                    <td>{{application.company}}</td>
                    <td>{{application.first_name}}&nbsp;{{application.last_name}}</td>
                    <td>{{application.date_applied}}</td>
                    <td><a href="{{application.secure_url}}">View Resume</a></td>
                </tr>
                {%endfor%}
            </tbody>
            <tfoot>
                <tr>
                    <td colspan="3"><a class="applications-table-link" hx-get="/review_applications" hx-target="#admin-main" hx-trigger="click" hx-indicator=".section-loader-wrapper">View All > </a></td>
                </tr>
            </tfoot>
        </table>
    </div>
</section>


<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script type="module"> 
    // <script type="module"> solves the problem of global-scope variables being stored in the memory and then throwing 'redeclaration not allowed' error when the template is revisited. This happens because the entire admin-interface is a single page. Modules have their own scope which prevents global scope pollution. 
    
    const barCtx = document.getElementById('barChart').getContext('2d');

    const gradient1 = barCtx.createLinearGradient(0, 0, 0, 400);
    gradient1.addColorStop(0, '#A0A0E3'); // Start color
    gradient1.addColorStop(1, '#190C91'); // End color

    const gradient2 = barCtx.createLinearGradient(0, 0, 0, 400);
    gradient2.addColorStop(1, '#A770EF'); // Start color
    gradient2.addColorStop(0, '#CF8BF3'); // End color

    const remoteData = {{ remote_data | tojson}}; //data from backend via Jinja
    const onsiteData = {{ onsite_data | tojson }};

    let delayed; /* Variable to check if the bar chart's delay animation has completed */

    let responsive_settings; /*will contain padding values, ticks font-size and 'maintainAspectRatio' attribute according to screen size*/
    if(window.matchMedia('(max-device-width: 768px)').matches){ /*check width for mobile devices*/
        console.log('matching');
        responsive_settings = {
            padding: {
                left: 10,
                right: 10,
                top: 10,
                bottom: 10
            },
            maintainAspectRatio: false,
            tick_font_size: 10
        }
    } 
    else{
        responsive_settings = {
            padding: {
                left: 40,
                right: 50,
                top: 10,
                bottom: 15
            },
            maintainAspectRatio: true,
            tick_font_size: 13
        }
    }


    const stackedBarChart = new Chart(barCtx, {
        type: 'bar',
        data: {
            labels: ['Full-Time', 'Part-Time', 'Freelance', 'Internship'], // Job types
            datasets: [
                {
                    label: 'Onsite Jobs',
                    data: onsiteData, // Number of onsite jobs for each job type
                    backgroundColor: gradient1, // Apply gradient to bars
                },
                {
                    label: 'Remote Jobs',
                    data: remoteData, // Number of remote jobs for each job type
                    backgroundColor: gradient2, // Apply gradient to bars
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: responsive_settings.maintainAspectRatio,
            layout: {
                padding: {
                    left: responsive_settings.padding.left,
                    right: responsive_settings.padding.right,
                    top: responsive_settings.padding.top,
                    bottom: responsive_settings.padding.bottom
                }
            },
            animation: {
                onComplete: () => {
                    delayed = true;
                },
                delay: function (context) {
                    let delay = 0;
                    if (context.type === 'data' && context.mode === 'default' && !delayed) {
                        delay = context.dataIndex * 300 + context.datasetIndex * 100;
                    }
                    return delay;
                },
                duration: 1000, // Animation duration for each bar
            },
            scales: {
                x: {
                    stacked: true, // Enable stacking on the x-axis
                    title: {
                        display: true,
                        text: 'Job Types',
                        color: 'white',
                        font: {
                            size: 14, // Title font size
                            family: 'Plus Jakarta Sans' // Title font family
                        }
                    },
                    grid: {
                        display: true, // Show grid lines
                        color: '#ffffff10' // Grid line color
                    },
                    ticks: {
                        color: 'rgb(195, 212, 255)', // Tick label color
                        font: {
                            size: responsive_settings.tick_font_size, // Tick label font size
                            family: 'Plus Jakarta Sans' // Tick label font family
                        }
                    },
                    // Adjusting categoryPercentage and barPercentage to eliminate gaps
                    categoryPercentage: 1.0, // Use the full width for each category
                    barPercentage: 1.0, // Use the full width for each bar
                },
                y: {
                    stacked: true, // Enable stacking on the y-axis
                    title: {
                        display: true,
                        text: 'Number of Jobs',
                        color: 'white',
                        font: {
                            size: 14, // Title font size
                            family: 'Plus Jakarta Sans' // Title font family
                        },
                        padding: {
                            bottom: 10,
                            top: 0
                        }
                    },
                    grid: {
                        display: true, // Show grid lines
                        color: '#ffffff10' // Grid line color
                    },
                    ticks: {
                        color: 'rgb(195, 212, 255)', // Tick label color
                        font: {
                            size: 10, // Tick label font size
                            family: 'Plus Jakarta Sans' // Tick label font family
                        }
                    }
                }
            },
            plugins: {
                legend: {
                    display: true,
                    position: 'top',
                    labels: {
                        color: 'white', // Legend text color
                        usePointStyle: true,
                        font: {
                            size: 12, // Legend text font size
                            family: 'Arial' // Legend text font family
                        }
                    }
                },
                tooltip: {
                    titleColor: '#fff', // Tooltip title color
                    bodyColor: '#fff', // Tooltip body text color
                    borderWidth: 1, // Tooltip border width
                    padding: 10, // Tooltip padding
                    cornerRadius: 5 // Tooltip corner radius
                }
            }
        }
    });

    const doughnutCtx = document.getElementById('doughnutChart').getContext('2d');
    const doughnutData = {{ doughnut_chart_data | tojson}};

    function createDoughnutChart() { //since doughnut chart is not in viewport initially, it is not created on load but on intersection with viewport
        const applicationsDoughnutChart = new Chart(doughnutCtx, {
            type: 'doughnut',
            data: {
                labels: Object.keys(doughnutData),
                datasets: [{
                    label: 'Applications',
                    data: Object.values(doughnutData),
                    backgroundColor: [
                        '#519DE9',
                        '#73C5C5',
                        '#8481DD'
                    ],
                    borderColor: [
                        '#1F2371',
                        '#4959A6',
                        '#5A3878'
                    ],
                    borderWidth: 1,
                    hoverOffset: 8
                }]
            },
            options: {
                responsive: true,
                cutout: '50%',
                layout: {
                    padding: {
                        left: 50,
                        right: 50,
                        top: 20,
                        bottom: 20
                    }
                },
                plugins: {
                    legend: {
                        position: 'bottom',
                        align: 'start',
                        labels: {
                            color: 'white',
                            usePointStyle: true,
                            boxWidth: 20,
                            font: {
                                size: 14,
                                family: 'Plus Jakarta Sans',
                            },
                            padding: 10
                        }
                    },

                    tooltip: {
                        callbacks: {
                            label: function (context) {
                                const label = context.label || '';
                                const value = context.raw;
                                return `${label}: ${value}`;
                            }
                        }
                    }
                },
                animation: {
                    duration: 1700,
                    animateRotate: true,
                },
                hover: {
                    mode: 'nearest',
                    intersect: true,
                }
            }
        }
        );
    }

    // IntersectionObserver for creating doughnut chart on scroll
    const observerCallback = (entries, observer) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                createDoughnutChart();
                observer.unobserve(entry.target); // Stop observing after the animation triggers
            }
        });
    };

    // Create IntersectionObserver instance
    const observerOptions = {
        threshold: 0.5 // Trigger when 50% of the chart is visible
    };
    const observer = new IntersectionObserver(observerCallback, observerOptions);

    // Observe the doughnut chart container
    observer.observe(document.querySelector('.doughnutContainer'));


    // SIDEBAR LINK HIGHLIGHT WHEN CLICKING ON RECENT POSTINGS AND RECENT APPLICATIONS LINKS:
    const links = document.querySelectorAll('.sidebar a');
    const summaryTableLinks = document.querySelectorAll('tfoot a');
    summaryTableLinks.forEach(table_link => {
            table_link.addEventListener('click', () => {
                if(table_link.classList.contains('jobs-table-link')){
                    links[0].classList.remove('selected');
                    links[1].classList.add('selected');
                }
                else if(table_link.classList.contains('applications-table-link')){
                    links[0].classList.remove('selected');
                    links[2].classList.add('selected');
                }
            });
        });
</script>
